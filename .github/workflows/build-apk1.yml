name: Build APK
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Use a system Gradle (no gradlew needed)
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.7

      - name: Build debug APK (robust path handling)
        shell: bash
        run: |
          set -euxo pipefail

          # If your project folder is SpotMyRepAndroid/, cd into it; else stay at root
          if [ -d "SpotMyRepAndroid" ]; then
            cd SpotMyRepAndroid
          fi

          # If root Gradle files are missing, create minimal ones (safe if already present)
          if [ ! -f settings.gradle ] && [ ! -f settings.gradle.kts ]; then
            echo 'pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }' > settings.gradle.kts
            cat >> settings.gradle.kts <<'EOF'
dependencyResolutionManagement {
  repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
  repositories { google(); mavenCentral() }
}
rootProject.name = "SpotMyRepAndroid"
include(":app")
EOF
          fi

          if [ ! -f build.gradle ] && [ ! -f build.gradle.kts ]; then
            cat > build.gradle.kts <<'EOF'
plugins {
  id("com.android.application") version "8.1.2" apply false
  id("org.jetbrains.kotlin.android") version "1.9.0" apply false
}
EOF
          fi

          # Build the debug APK
          gradle -v
          gradle assembleDebug

      - name: List outputs (debug)
        run: |
          echo "Searching for APKs..."
          find . -type f -name "*.apk" -print || true

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spotmyrep-apk
          path: |
            **/app/build/outputs/**/*.apk
          if-no-files-found: error