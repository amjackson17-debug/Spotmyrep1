name: Build APK
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.7

      - name: Build debug APK (robust)
        shell: bash
        run: |
          set -euxo pipefail
          # go into project folder if it exists
          if [ -d "SpotMyRepAndroid" ]; then cd SpotMyRepAndroid; fi

          # make minimal Gradle root files if missing
          if [ ! -f settings.gradle ] && [ ! -f settings.gradle.kts ]; then
            cat > settings.gradle.kts <<'EOF'
pluginManagement {
    repositories { google(); mavenCentral(); gradlePluginPortal() }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories { google(); mavenCentral() }
}
rootProject.name = "SpotMyRepAndroid"
include(":app")
EOF
          fi

          if [ ! -f build.gradle ] && [ ! -f build.gradle.kts ]; then
            cat > build.gradle.kts <<'EOF'
plugins {
    id("com.android.application") version "8.1.2" apply false
    id("org.jetbrains.kotlin.android") version "1.9.0" apply false
}
EOF
          fi

          gradle assembleDebug

      - name: List outputs
        run: find . -type f -name "*.apk" -print || true

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: spotmyrep-apk
          path: '**/app/build/outputs/**/*.apk'
          if-no-files-found: error